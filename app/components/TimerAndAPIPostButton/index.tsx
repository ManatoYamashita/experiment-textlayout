"use client";

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import styles from './index.module.scss';
import { Button } from '@/components/ui/button';

interface ButtonsProps {
  currentText: string;
  currentMargin: number;
}

export default function TimerAndAPIPostButton({ currentText, currentMargin }: ButtonsProps) {
  const [time, setTime] = useState(0);
  const [hasActionBeenPerformed, setHasActionBeenPerformed] = useState(false);
  const router = useRouter();
  const pathname = usePathname();

  const texts = useMemo(
    () => [
  
      `『狙われた星』
      「こんどは、あの星の連中をやっつけて楽しもうぜ」 金属質のウロコで全身をおおわれた生物は、彼らの宇宙船のなかで、仲間にこう言った。「よかろう」 ほかの連中もウロコを逆立て、からだをくねらせながら、うれしそうに応じた。その指さすところには、月をひとつ持った緑の惑星がある。「どうだい、ようすは」 彼らは高性能の望遠鏡をあやつって、その星の上をのぞいてみた。「やあ、いるぞ、いるぞ。二本足を使って、ぞろぞろ動きまわっているぞ。ところで、今度はどういう方法で、やっつけることにするか」「そうだな。熱線で焼き払うのはやったことがあるし、このあいだの星では、凶暴ガスを吸わせて、おたがいに殺しあわせる手を使ってしまった。なにかもっと、刺激的なやっつけ方はないものかな」「ああ、すごいやつでな……」 彼らは攻撃方法を相談しあった。そのうちの一人が小型の宇宙艇に乗って、地上にむかっていった。数時間ほどして戻り、報告がなされた。「いってきました」「ごくろう。うまくいったか」「一匹つかまえて、その皮をはいできました」「そうとう暴れたろう」「もちろんですよ。ものすごい悲鳴をあげての、抵抗でした。だが、われわれのほうが力は強い。それにしても、この星のやつら、なかなか死にませんね。皮をはいでも、まだ動きまわって……」「そいつは面白かったろうな。ところで、これからどうする」「いま、皮を研究班に渡してきました。それを溶かすビールスを作らせています」「それはいい。やつらの皮膚がビールスにおかされ、どろどろに溶けるのを、われわれはここから見物できるわけだな。早く見たいものだ」 彼らは期待でわくわくしながら、待った。そのうち、研究班が完成を知らせに来る。「できました」「よし、さっそくばらまこう」 彼らの宇宙船はその星を一周し、ビールスをまんべんなく、まき散らした。「さあ、もうすぐ、やつらののたうち回って苦しむところが見られるぞ」「そら、きいてきた……」 しかし、彼らは不満げな声で話しあった。「おかしいぞ。やつらはあわてているが、だれも死なないじゃないか。死なないどころか、なかには、むしろ喜んでいるやつもいるようだ」「変ですね。なんだか薄気味わるくなってきた。もうやめて、引きあげましょう」「ああ、べつの星にいこう」 彼らの去ってゆく星、地球上では、その時しかつめらしい顔の学者たちが、だれもかれもが突然はだかになった現象を解決すべく、調査にとりかかりはじめていた。
      `,

  
      `『盗んだ書類』
      静かな夜ふけ。エフ博士の研究所のそばに、ひとりの男がひそんでいた。その男は泥棒だった。 エフ博士はこれまでに、すばらしい薬をつぎつぎと発明してきた。まもなく、また新しい薬を完成するらしいとのうわさだった。男はその秘密を早いところ盗み出し、よそに売りとばそうという計画をたてたのだ。 男は窓から、そっとのぞきこんだ。なかではエフ博士がひとり、むちゅうになって薬をまぜあわせている。熱中しすぎて、のぞかれていることに気がつかない。 やがて、少量の薬ができあがった。みどり色をした液体だった。博士はそれを飲み、大きくうなずいた。「うむ、味は悪くない。においもこれでいいだろう……」 そして、のびをしながらつぶやいた。「やれやれ、やっとできた。いままでにわたしは、いろいろな薬を作った。しかし、この薬にまさる薬はあるまい。世界的な大発明だ。さて、忘れないうちに、製造法を書きとめておくとしよう」 博士は紙に書き、それを部屋のすみの金庫のなかに、大事そうにしまいこんだ。それから、自分の家へと帰っていった。 待ちかまえていた男は、仕事にとりかかった。注意して窓をこじあけ、なかにしのびこむ。さっき博士がやった通りに金庫のダイヤルの番号を合わせると、簡単にあけることができた。男は書類をポケットに入れ、うれしそうな足どりで逃げ出した。「しめしめ、これでひともうけできるぞ。博士が飲んだところをみると、人体に害のないことはたしかだ。それに、すごい薬とか言っていた。だが、どんなききめがあるのだろうか……」 その点が、なぞだった。飲んだあと博士がどうなったのか、調べるひまはなかった。電話をかけて聞くわけにもいかない。しかし、エフ博士の発明だから、いままでの例からみて、役に立つ薬であることはあきらかだ。 かくれ家に引きあげた男は、紙に書いてある製法に従って、薬を作ってみることにした。どんな作用があるのか知っていないと、ひとに売りつける時に困るのだ。 原料を集め、フラスコやビーカーも買いととのえた。そして、何日かかかって、問題の薬ができあがった。スズランのような、いいにおいがする。 男はそれを自分で飲んでみた。すがすがしい味がした。男は椅子に腰をかけ、ききめがあらわれるのを待った。 そのうち、男は立ちあがり、そとへ出た。急ぎ足で歩きつづけ、ついたところはエフ博士の研究所だった。「先生。申しわけないことをしました。このあいだ、ここの金庫から書類を盗んでいったのは、わたしです。わたしをつかまえ、警察へつき出して下さい」 と男は言った。それを迎えた博士は念を押した。「本当にあなたなのですか」「そうです。書いてある通りにやって薬を作り、それを飲んでみました。そうすると、自分のしたことが悪かったのに気づき、ここへやってきたのです。お許し下さい。盗んだ書類はおかえしします」 男は涙を流してあやまった。だが、エフ博士は怒ろうともせず、にっこり笑いながら言った。「それはそれは。やはり、わたしの発明はききめがあった。この薬は、良心をめざめさせる作用を持ったものです。ところが、作ってはみたものの、あとで困ったことに気がついた。実験のために、進んで飲んでみようという悪人がいないのです。しかし、あなたのおかげで、作用のたしかさが証明できたというわけです。どうも、ごくろうさまでした」
      `,
  
      `『約束』
      春の日の午後。あたたかい陽ざしは野原いちめんにひろがり、そこでは緑の草と色とりどりの花々とが、かげろうでまぜられて限りない揺れをつづけていた。 銀色に輝く飛行物体がどこからともなく現われて、静かにそこに着陸した。軽い金属的な音をひびかせて開いたドアからは、真紅の服をぴったりと身に着けた三人が出てきた。野原で鬼ごっこをしたり、花をつんでいた子供たちは、目ざとくそれを見つけた。「あっ、あんな人たちが出てきたよ」「なんだろう。行ってみよう」 子供たちはかけより、あどけない声で呼びかけた。「ねえ、おじちゃんたち。それに乗ってどこから来たの」 しばらくして、真紅の服の一人が奇妙なアクセントで答えた。「われわれは空のむこうの、遠い遠い星からきたんだよ」「なにしにきたの、どこへ行くの」 子供たちは、おそるおそる服にさわりながら、口々に聞いた。「べつな星に調査に行く途中なのだが、この星を見かけて、ちょっとおりてみたのだよ。ゆっくりはできないが、標本にする植物を少し集めていこうと思ってね」 それに対し、「じゃあ、ぼくの集めたお花をあげるよ」「うん。ぼくたちが手伝ってあげよう」 子供たちは、また野原のかげろうのなかにちらばり、しばらくしてつぎつぎと戻ってきた。「ほら、こんなに集めてきたよ」「ぼくはこれだけ」「ありがとう。おかげで早く仕事がすんだよ。お礼になにをあげようか」 と真紅の服の人物は言い、子供たちはひそひそと相談しあった。「おじちゃんたち、どんなことができるの」「われわれは文明がここよりずっと進んでいるから、たいていのことはできるだろう。なにかして欲しいことでもあるのなら、言ってごらん」「それならね。大人たちのやり方を、あらためさせてほしいな。大人たちに、ウソをつかせないようにすることなんかもできる……」「ああ、できないこともないよ」「ほんと。大人って悪いことばかりしているんだよ。よくわかんないけれど、ワイロなんてことも……」「わかった。やってあげるよ。だが、われわれには急ぎの仕事がある。帰りには必ず寄って、やってあげるから、待っていておくれ。約束はきっと果たすよ」「うん。きっと来てね。待っているよ」 さよなら、さよなら、と呼びかわす夕もやのなかを、物体は上昇し飛び去っていった。「きもちのいい連中でしたね」 そのなかで宇宙人はこう同僚に言った。「さあ、急ごう。そして、早く約束を果たしてやろう」 飛行物体は目的地めざし、暗い虚空で速力をあげた。 帰路。彼らはふたたび約束の星におりたった。「さて、あの連中はどうしたろう。きみたち、さがしてきてくれないか」 と一人が残り、二人は約束の相手たちをさがすために出ていった。そして、戻った。「おそかったじゃないか」「だいぶ成長していて、見つけるのに手間どってしまってね」「それで見つかったのか、約束の相手たちは」「見つけはしましたが、どうも変ですね、この星の連中は」「いったい、どうだったんだ」「すっかり忘れているのです。そこで、こっちから言いだしてみたのですが、太った腹をなでながら、だれもがこんな返事でしたよ。ああ、そんなこともあったかな、だが、そんな約束はなかったことにして、いまさらよけいなことはしないでくれ、とね」
      `,
  
      `『デラックスな金庫』
      私はほとんど全財産をつぎこんで、豪華きわまる大金庫を作った。ばかなことをするやつだ、と言うやつもある。だが、そんな連中だって、これとあまり大差ない。 自動車を買って、いままでの倍の時間をかけて通勤し、とくいがる者。時間にルーズなくせに、宝石をちりばめた高級時計を身につける者。趣味となると人は盲目的に金を使い、後悔しない。私の場合だってそれと同じだ。 家は手放してしまったので、アパートの一室に住んでいる。しかし、世の中には金庫を盗もうと考える者などいないから、外出の時も心配ない。 私はひまさえあれば、金庫をみがくことに熱中する。鋼鉄製だが、外側は銀張りなのだ。ためつすがめつ眺め、少しでも曇りをみつけると、やわらかい布でこする。やさしく、そっと。ちょうど、多くの人が美人のはだに触れるように。それにつれて、金庫の表面は輝きをまし、私の姿をうつしはじめ、私は悦に入る。 楽しいその仕事が終り、夜となると、金庫のほうをむいてベッドの上に横になり、満足感とともに眠りに入る。じつにいい趣味ではないか。「おい、起きろ」 ある夜、とつぜんゆり起された。目をあけてみると、そばに覆面の男が立っていて、私にナイフをつきつけている。「金庫にだけは、さわらないでくれ」 と、私は思わず叫んだ。だれだって変なやつに趣味の品をさわられるのは、いやだろう。しかし、気がつくと手足をしばられていたので、それ以上、どうすることもできなかった。「声を出すな。前から目をつけていたのだ。さあ、そのあけ方を教えろ」「しかし、なかには……」「静かにしろ」 男は、私にサルグツワをかけて言った。「さあ、紙にダイヤルの番号を書け」 しかたがない。私はしばられたまま指をぎこちなく動かし、それを書いた。男は乱暴な手つきで、ダイヤルをまわした。目をそむけたくなるような気持ちだ。 オルゴールの「金と銀」の曲とともに扉が開き、なかの照明がついた。まばゆい黄金色の光が、そとにあふれ出た。金庫の内側が、金張りになっているからだ。私のように凝った趣味の者は、このように見えないところに金をかける。 男は目を細め、その光に魅せられたように思わずなかに歩み入る。それにつれ、扉が静かに閉じる。赤外線利用のこのしかけも、私の自慢のものである。「なんだ、なにもないじゃないか。あけろ」 なかから、かすかに声がした。だが、しばられていてはあけようがない。つづいて、あばれるけはいがする。うまいぐあいだ。あばれてくれれば自動的にサイレンが鳴りだす装置も、ついているのだ。すぐにだれかが、とんでくるだろう。 これでまた、犯人逮捕の金一封がもらえるというわけだ。そして、なかの金張りの厚さもふえる。どうだ、実益だってちゃんと、ともなっているではないか。
      `,
  
      `『プレゼント』
      「おい、見ろ。あの星で、しきりに核爆発が起っている」「そうか。文明がその段階に達したとなると、ぐずぐずしているわけにいかない。では、早いところ、例のものを送りつけることにしよう」 宇宙の一角にあるラール星の住民たちは、こんなことを話しあい、やがて一台の宇宙船を発射した。「なんだ、あれは。妙なものが現れたぞ」 と、ひとりが空を指さしながら叫んだ。「飛行物体のようだな」「たぶんね。知りたいのは、どこの星から発射され、なんの目的でこの地球に飛んできたかだ」「わかるものか。なかに入っているものが判明するまでは」 だれもが空を見あげて大さわぎをしているうちに、それは郊外の原っぱに落下した。 正体不明の飛行物体が、地球製のものでないことは、すぐにわかった。それは、あまりにも大きかったのだ。百階建てのビルぐらいあった。人びとは首をかしげ、好奇心と不安のまざった視線を集中しつづけた。 そのうち、その銀色の物体の一部に音がした。きしむような響きとともに、ドアらしきものがゆっくりと開いた。「いよいよ、なにか出てくるらしい」「どんなやつだろう」 あたりの緊張は高まった。しかし、その静けさはすぐにおわった。いっせいに悲鳴がおこったのだ。「危ない。逃げろ」「なんと恐ろしい怪物だろう。ふみつぶされるぞ」 たしかに、怪物としか呼びようがなかった。トカゲとカバとをいっしょにしたような姿だったが、ちょっとしたビルほどの大きさで、太い六本の足でのそのそと歩きはじめた。そして、歩くたびに、足の下にあった物は、なにもかもふみつぶされた。しかも、一匹でなく、十匹ちかく現われた。 色はさびた鉄のような色だった。色ばかりでなく、丈夫さも鉄ぐらい、いや、それ以上だった。だれかが反射的に銃をむけて引金をひいたが、弾丸は皮膚ではねかえされた。 ただちに非常警戒網がはられた。人びとは避難し、かわって、遠まきに武器が用意された。「ねらえ。うて」 バズーカ砲が、つづけざまに発射された。だが、怪物はいっこうにひるまなかった。「だめだ。ミサイルを使おう」 しかし、ミサイルも、あまり効果をあげなかった。怪物たちは大きいくせに意外に動きがすばやく、巧みに身をかわされて、なかなか命中しなかった。身をかわされるたびに、その下敷きになって、いくつかの建物が押しつぶされた。 とても、一国だけの手に負える相手ではなかった。各国に応援が求められ、各国はそれに応じた。ほっておいたら、世界じゅうが荒らされてしまいそうに思われたのだ。すでに、怪物たちは繁殖をはじめるけはいを示している。 国際間の対立は、もちろんたなあげとなり、怪物問題にすべての力が集められた。情報と研究が交換され、あらゆる科学力が動員された。高圧の電流を通じた鉄条網が張られ、各種の毒を入れたえさがまかれ、地雷が埋められ、催眠ガスが使用された。このうちのどれが有効だったのかわからないが、あばれつづけていたさすがの怪物たちも、ついにまいった。 みなはほっとし、手を握りあいながら、話しあった。「やっと退治できた。大きくて強いが、それほど利口でもなかったようだ」「ああ、一時は、どうなることかと思った。とんでもない怪物を、おくりつけてきたものだな。だが、これで安心とはいえまい。これからも、あることにちがいない。われわれは地球上での争いは打ち切りにして、宇宙からの相手にそなえなければならないだろう」「その通りだ。考えてみれば、いままでの原水爆の実験競争など、実にばかばかしいことだった。そのようなくだらないことは、こんご二度としないことにしよう」「そのご、核爆発は認められません」 ラール星の天文台は、こう発表した。「よかった。われわれの心のこもった贈り物が、役に立ったようだ」「当り前さ。こんなかわいい生物を見たら、だれだって心がなごやかになり、殺気だった気持ちも静まってくる。あの星の住民たちも、いまごろは、さぞ喜んでいることだろう」 こう話しあいながら、ラール星の巨大な住民たちは、足もとにじゃれつく六本足のペットたちの頭を、目を細めてなでた。
      `,
  
      `『キツツキ計画』
      都会からはなれた森のなかに、小さな家があった。しかし、それは別荘などではなく、悪人団の本部だった。 ある日。その首領は、ここに子分たちを呼び集めて言った。「大きな計画を思いついたぞ。おまえたちにも、ひと働きしてもらわなければならない」「銀行強盗でもやろうというのですか」 と子分たちは身を乗り出した。だが、首領は手を振った。「いや、そんなけちなことではない。いままで、だれひとり考えもしなかったような、どえらい仕事だ。どうだ。やってみるか」「やりますとも。命令を出して下さい」「それでは、まず町へ行って金網を買ってきてくれ」 それを聞いて子分たちは首をかしげた。「なんに使うのですか」「大きな鳥小屋を作るのだ」「気はたしかなんですか。ちっとも、どえらい仕事とは思えませんが」「そのなかで、たくさんのキツツキを育てるのだ」「ますます、わからなくなりました」 とふしぎがる子分に、首領は言った。「おまえたちにもわからないとなると、だれにも気づかれることなく、この計画を進めることができそうだ。成功への自信がついてきたぞ」「いったい、キツツキをどうするのです」「押しボタンを見ると、クチバシで突っつくように訓練する。そして、町にむけて飛び立たせるのだ。どうなると思う」「家の門などについている、ベルのボタンを押すでしょうね」「そうだ。そればかりではない。火災用だの、防犯用だのの非常ベルを、いたるところで押すわけだ」 説明されているうちに、子分たちにもしだいにわかってきた。「警察は、さぞあわてるでしょう」「そのほか、オートメーション工場に忍びこんでボタンを押しまくれば、変な品物がぞくぞく出てくる。電子計算機のある部屋に飛びこんでキーを押せば、めちゃくちゃな答えが出はじめる」「町じゅう、大混乱になりますね」「そこだよ。そこへわれわれが乗りこむ。どさくさまぎれに、欲しい品物を手当りしだいに持ってこれるというわけだ」「なるほど、なるほど。わかりました。さすがに首領だけあって、すごい計画です。さっそく、とりかかりましょう」 子分たちは大きな鳥小屋を作り、キツツキを育て、数もふやした。毎日エサをやりながら、クチバシでボタンを押すように訓練した。 やがて、これでよしと見きわめをつけた首領は、キツツキをいっせいに飛ばせた。「さあ、ラジオを聞きながら待とう。まもなく、大さわぎのニュースが放送されるだろう。そうしたら、われわれはトラックに乗って出発するのだ」 しかし、いくら待っても臨時ニュースは放送されなかった。夜になって待ちくたびれたころ、こんな平凡なニュースが放送された。「きょう、町はずれにある鳥の研究所にいたずら者が入りこんだらしく、ドアをあけるボタンが、しらないまに押されてしまいました。そのため、実験用に飼っていた、たくさんのタカが飛出してしまいました。しかし、夕方になると、ほとんどが戻ってきました。犯人はまだ不明ですが、このタカによって被害を受けたかたは、研究所へ申し出れば、損害に相当するお金を払ってくれるそうです……」 これを聞いて、悪人たちはがっかりした。 はじめに、とんでもないボタンを押してしまったようだ。せっかく飛ばせたキツツキが、みなタカに食べられてしまったらしい。大もうけの計画がだめになり、大損害だ。しかし、だからといって、このことを申し出るわけにはいかない。
      `,
  
      `『愛用の時計』
      Ｋ氏は週末の旅行に出かけるため、用意をととのえていた。服のポケットのなかでは、ラジオが天気予報を告げていた。〈あすは、よいお天気でしょう……〉 楽しげに口笛を吹きながら、 Ｋ氏はハンケチを出し、腕時計を軽くぬぐった。これは彼のいつもの癖だった。 癖とはいうものの、頭をかくとか耳をつまむとかいう、意味もない動作とはちがっていた。彼はその時計を大切にしていたのだ。大げさな形容をすれば、愛していたともいえる。 Ｋ氏がこれを買ってから、五年ほどになる。デパートの時計売場のそばを通ったとき、ガラスのケースのなかに並べられた、たくさんの時計の一つがキラリと光った。ちょうど、女の子にウインクされたような気がした。また、「あたしを買ってくれない……」 と、やさしく、ささやきかけられたようにも思えた。古代の異国の金貨が、文字盤になっている。たまたま、入社してはじめてのボーナスをもらった日だった。「よし。買うことにしよう」 彼は思わずこうつぶやいた。それ以来、時計はずっと、 Ｋ氏とともにいる。 Ｋ氏は、からだの一部ででもあるかのように扱った。彼はまだ若く、自分では定期的な健康診断などを受ける気にはならなかったが、時計のほうは定期的に検査に出した。別なのを使うその数日は、彼にとって、たまらなくさびしい日だった。 しかし、そのため、狂ったりすることはまったくなかった。進みすぎもせず、おくれもせず、正確な時刻を、忠実に知らせつづけてきたのだ。 その時、ラジオが時報の音をたてた。 Ｋ氏は首をかしげた。「おかしいぞ。時報が狂うとは」 彼にとって、時計のほうを疑うのは、考えられないことだった。だが、ダイヤルをまわし、ほかの局を調べ、時報が正しいのを知って、あわてた。 もはや、切符を買っておいたバスの、発車時刻にまにあわなくなっている。彼は時計に文句を言った。「おい。なんということをしてくれたのだ。これだけ大切に扱ってやっているのに」 しかし、どうしようもなかった。 Ｋ氏は旅行を中止し、散歩にでかけた。そして、ついでに時計店に立ち寄った。「変なんだ。おくれはじめた。せっかくの週末が、ふいになってしまった」「しかし、このあいだ検査をしたばかりですが……」 と、時計店の主人は受けとり、機械をのぞきこんでいたが、ふしぎそうな声で答えた。「変ですね。どこにも故障なんかないようです」「そんなはずはない」 そのとき、ポケットに入れっぱなしになっていたラジオが、ニュースをしゃべった。〈観光シーズンです。 Ｓ山へ行くバスが……〉 それを聞きながら、 Ｋ氏は主張した。「おかげで、このバスに乗りそこなったのだ。たしかに、この時計はどうかしている」 しかし、ニュースはそのさきをこう告げていた。 〈……事故のため、谷へ転落して……〉
      `,
  
      `『おみやげ』
      フロル星人たちの乗った一台の宇宙船は、星々の旅をつづける途中、ちょっと地球へも立ち寄った。しかし、人類と会うことはできなかった。なぜなら、人類が出現するよりずっと昔のことだったのだ。 フロル星人たちは宇宙船を着陸させ、ひと通りの調査をしてから、こんな意味のことを話しあった。「どうやら、わたしたちのやってくるのが、早すぎたようですね。この星には、まだ、文明らしきものはありません。最も知能のある生物といったら、サルぐらいなものです。もっと進化したものがあらわれるには、しばらく年月がかかります」「そうか。それは残念だな。文明をもたらそうと思って立ち寄ったのに。しかし、このまま引きあげるのも心残りだ」「どうしましょうか」「おみやげを残して帰るとしよう」 フロル星人たちは、その作業にとりかかった。金属製の大きなタマゴ型の容器を作り、そのなかにいろいろのものを入れたのだ。 簡単に宇宙を飛びまわれるロケットの設計図。あらゆる病気をなおし、若がえることのできる薬の作り方。みなが平和に暮すには、どうしたらいいかを書いた本。さらに、文字が通じないといけないので、絵入りの辞書をも加えた。「作業は終りました。将来、住民たちがこれを発見したら、どんなに喜ぶことでしょう」「ああ、もちろんだとも」「しかし、早くあけすぎて、価値のある物とも知らずに捨ててしまうことはないでしょうか」「これは丈夫な金属でできている。これをあけられるぐらいに文明が進んでいれば、書いてあることを理解できるはずだ」「そうですね。ところで、これをどこに残しましょう」「海岸ちかくでは、津波にさらわれて海の底に沈んでしまう。山の上では、噴火したりするといけない。それらの心配のない、なるべく乾燥した場所がいいだろう」 フロル星人たちは、海からも山からもはなれた砂漠のひろがっている地方を選び、そこに置いて飛びたっていった。 砂の上に残された大きな銀色のタマゴは、昼間は太陽を反射して強く光り、夜には月や星の光を受けて静かに輝いていた。あけられる時を待ちながら。 長い長い年月がたっていった。地球の動物たちも少しずつ進化し、サルのなかまのなかから道具や火を使う種族、つまり人類があらわれてきた。 なかにはこれを見つけた者があったかもしれない。だが、気味わるがって近よろうとはしなかったろうし、近づいたところで、正体を知ることはできなかったにちがいない。 銀色のタマゴはずっと待ちつづけていた。砂漠地方なので、めったに雨は降らなかった。もっとも、雨でぬれてもさびることのない金属でできていた。 時どき強い風が吹いた。風は砂を飛ばし、タマゴを埋めたりもした。しかし、埋めっぱなしでもなかった。べつな風によって、地上にあらわれることもある。これが何度となく、くりかえされていたのだった。 また、長い長い年月が過ぎていった。人間たちはしだいに数がふえ、道具や品物も作り、文明も高くなってきた。 そして、ついに金属製のタマゴの割れる日が来た。しかし、砂のなかから発見され、喜びの声とともに開かれたのではなかった。下にそんなものが埋まっているとは少しも気づかず、その砂漠で原爆実験がおこなわれたのだ。 その爆発はすごかった。容器のそとがわの金属ばかりでなく、なかにつめてあったものまで、すべてをこなごなにし、あとかたもなく焼きつくしてしまったのだ。
      `,
  ],[]);
   // 星新一 『ボッコちゃん』から引用

  const randomMargins = useMemo(() => [8, 11, 17, 25, 33], []); // 8.3, 11.08, 16.63, 24.94, 33.26

  // タイマーを起動
  useEffect(() => {
    const interval = setInterval(() => {
      setTime((prevTime) => prevTime + 1);
    }, 1000);

    return () => clearInterval(interval); // クリーンアップ
  }, []);

  // 時間と選択されたテキストの5文字、randomMarginを送信する関数
  const handleSubmit = useCallback(async (time: number, selectedTextFirst5: string, selectedMargin: number) => {
    try {
      console.log(`
        Sending data: time=${time}, 
        selectedTextFirst5=${selectedTextFirst5}, 
        randomMargin=${selectedMargin}`);
      const response = await fetch('/api/submitToGoogleSpreadSheet', { 
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ time, selectedTextFirst5, selectedMargin })
      });

      if (response.ok) {
        const result = await response.json();
        console.log(result.message);
      } else {
        console.error('サーバーエラーが発生しました');
        // 失敗時にボタンを再度有効化
        setHasActionBeenPerformed(false);
        alert('データの送信に失敗しました。もう一度お試しください。');
      }
    } catch (error) {
      console.error('エラーが発生しました:', error);
      // 失敗時にボタンを再度有効化
      setHasActionBeenPerformed(false);
      alert('データの送信中にエラーが発生しました。もう一度お試しください。');
    }
  }, []);

  // ページ遷移の関数
  const handleNavigation = useCallback((selectedPhrase: string, randomMargin: number) => {
    router.push(`/layouted?text=${encodeURIComponent(selectedPhrase)}&margin=${randomMargin}`);
  }, [router]);

  // 全体の処理をまとめた関数
  const handleAction = useCallback(async () => {
    if (hasActionBeenPerformed) return; // 二度押し防止

    // 1. 現在のmarginを取得
    const selectedMargin = currentMargin;

    // 2. 現在のテキストの最初の5文字を取得
    const selectedTextFirst5 = currentText.substring(0, 5);

    // 3. 時間と選択されたテキストの5文字、randomMarginを送信
    await handleSubmit(time, selectedTextFirst5, selectedMargin);

    // 4. ランダムなインデックスを選択して新しいテキストを取得
    const randomIndex = Math.floor(Math.random() * texts.length);
    const selectedPhrase = texts[randomIndex];

    // 5. ランダムなrandomMarginを更新
    const randomMargin = randomMargins[Math.floor(Math.random() * randomMargins.length)];

    // 5. タイマーをリセット
    setTime(0);

    // 6. アクションが成功した場合のみ状態を更新
    setHasActionBeenPerformed(true);

    // 7. ページ遷移（randomMarginをクエリパラメータとして追加）
    handleNavigation(selectedPhrase, randomMargin);
  }, [hasActionBeenPerformed, handleSubmit, time, texts, currentText, currentMargin, randomMargins, handleNavigation]);

  // MetaKey + Enter で動作するイベントリスナー
  useEffect(() => {
    const handleKeyDown = async (event: KeyboardEvent) => {
      if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
        await handleAction();
      }
    };

    window.addEventListener('keydown', handleKeyDown);

    // クリーンアップ
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
    };
  }, [handleAction]);

  // パスが変更されたら状態をリセット
  useEffect(() => {
    setHasActionBeenPerformed(false);
  }, [pathname]);

  // timeが0になったらボタンを再度押せるようにする
  useEffect(() => {
    if (time === 0) {
      setHasActionBeenPerformed(false);
    }
  }, [time]);

  return (
    <div>
      <h1>タイマー: {time} 秒</h1>
      <Button
        type="submit"
        onClick={handleAction}
        className={styles.btn}
        disabled={hasActionBeenPerformed}
      >
        <strong className={styles.strong}>Next</strong>
        <small className={styles.small}>（Command + Enter）</small>
      </Button>
    </div>
  );
}
